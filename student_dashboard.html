<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - SPARS Eduwise</title>
    <link rel="stylesheet" href="student_dashborad.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <header class="site-header">
        <div class="header-content">
            <div class="site-branding">
                <a href="index.html" class="logo-link" aria-label="Go to homepage">
                    <img src="logo.jpg" alt="SPARS Eduwise Logo" class="logo-img">
                    <span class="logo-text">Eduwise</span>
                </a>
            </div>
            <nav class="main-nav">
                <ul class="nav-list">
                    <li class="nav-item"><a href="#" id="logout-link" class="nav-link">Logout</a></li>
                    <li class="nav-item"><a href="#" class="nav-link active">Dashboard</a></li>
                    <li class="nav-item"><a href="#" class="nav-link">Reports</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="dashboard-page">
        <section class="dashboard-section">
            <div class="dashboard-grid">
                <aside class="panel panel-left">
                    <div class="profile-card card">
                        <div class="profile-top">
                            <div class="avatar"> <img src="logo.jpg" alt="avatar"/></div>
                            <div class="profile-info">
                                <h3 id="profileName">Student</h3>
                                <p id="profileEmail" class="muted">student@example.com</p>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <button class="btn" id="editProfileBtn">Edit Profile</button>
                            <button class="btn btn-outline" id="contactTeacherBtn">Contact Teacher</button>
                        </div>
                    </div>

                    <div class="stats-card card">
                        <h4 class="card-title">Quick Stats</h4>
                        <div class="stats-list">
                            <div class="stat">
                                <div class="stat-value" id="overallGradeSmall">N/A</div>
                                <div class="stat-label">Overall Grade</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="subjectsCount">0</div>
                                <div class="stat-label">Subjects</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="interviewReady">--</div>
                                <div class="stat-label">Interview Ready</div>
                            </div>
                        </div>
                    </div>
                </aside>

                <section class="panel panel-right">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title" id="welcome-title">Welcome, ...</h2>
                            <p class="dashboard-subtitle">Here's a summary of your academic progress.</p>
                        </div>
                        <div class="card-body card-body--row">
                            <div class="performance">
                                    <p class="score-lg" id="overallGrade">N/A</p>
                                    <p class="card-text" id="overall-message">No grades found.</p>
                                    <div style="margin-top:12px">
                                        <canvas id="gradesChart" aria-label="Grades chart" role="img"></canvas>
                                    </div>
                            </div>
                            <div class="interview" id="interviewSuggestion">
                                <h4>Interview Readiness</h4>
                                <div class="interview-body card-text">Evaluating your performance...</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Grades</h3>
                        </div>
                        <div class="card-body">
                            <div class="grades-table-wrapper">
                                <table class="grades-table" aria-describedby="recentGradesList">
                                    <thead>
                                        <tr><th>Subject</th><th>Score</th><th>Grade</th></tr>
                                    </thead>
                                    <tbody id="recentGradesList">
                                        <tr><td colspan="3">No grades found.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <a href="#" class="view-all-link">View all grades â†’</a>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Search Subject</h3>
                        </div>
                        <div class="card-body">
                            <form class="subject-search-form" id="subjectSearchForm">
                                <label for="subject-search" class="visually-hidden">Search for subject marks</label>
                                <div class="search-input-group">
                                    <input type="search" id="subject-search" placeholder="Enter subject name (e.g., Math, Science)" required>
                                    <button type="submit" class="search-btn">Search Marks</button>
                                </div>
                                <div id="searchResults" class="search-results"></div>
                            </form>
                        </div>
                    </div>
                </section>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <p>&copy; 2025 SPARS. All rights reserved.</p>
    </footer>

    <script>
    // Chart.js CDN (used only for rendering the small grades sparkline)
    (function(){
        var s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chart.js'; s.async=true; document.head.appendChild(s);
    })();
        document.addEventListener('DOMContentLoaded', async () => {
            
            const userEmail = localStorage.getItem('userEmail');
            
            if (!userEmail) {
                alert('You are not logged in. Redirecting to login page.');
                window.location.href = 'login.html';
                return; 
            }

            let studentData; 

            try {
                // const response = await fetch('http://localhost:3000/my-profile', {
                const response = await fetch('/api/my-profile', { // <-- CORRECT URL
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail })
                });
                
                if (!response.ok) {
                    throw new Error('Server returned an error');
                }

                const serverResponse = await response.json();

                if (serverResponse.success) {
                    // prefer server fullName, but fall back to a locally stored pending name
                    // Accept multiple server name fields (different casing/keys)
                    let nameFromServer = serverResponse.fullName || serverResponse.full_name || serverResponse.name || serverResponse.fullname || '';
                    // If server returned the generic placeholder 'Student' or empty, try localStorage
                    const pendingName = (localStorage.getItem('pendingFullName') || '').trim();
                    let finalName = nameFromServer && nameFromServer.toString().toLowerCase() !== 'student' ? nameFromServer : (pendingName || null);
                    // If still missing, derive from email (part before @)
                    if (!finalName && userEmail) {
                        let derived = userEmail.split('@')[0].replace(/\.|_|-/g, ' ');
                        // If derived value is all digits (like an ID), avoid showing that as a 'name'
                        if (/^\d+$/.test(derived.trim())) {
                            // prefer schoolId if available and not numeric-only name; otherwise fall back to generic 'Student'
                            const possibleSchoolId = serverResponse.schoolId || serverResponse.school_id || null;
                            finalName = possibleSchoolId ? `Student ${possibleSchoolId}` : 'Student';
                        } else {
                            finalName = derived.split(' ').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');
                        }
                    }

                    studentData = {
                        name: finalName || 'Student',
                        grades: serverResponse.grades || {} 
                    };

                    // clear pending name now that we've used it
                    try { localStorage.removeItem('pendingFullName'); } catch (e) {}

                    document.getElementById('welcome-title').textContent = `Welcome, ${studentData.name}!`;

                    function updateRecentGrades() {
                        const tbody = document.getElementById('recentGradesList');
                        tbody.innerHTML = '';
                        const hasGrades = studentData.grades && Object.keys(studentData.grades).length > 0;

                        if (hasGrades) {
                            const entries = Object.keys(studentData.grades);
                            // show latest up to 6
                            const recent = entries.slice(-6);
                            recent.reverse().forEach(subject => {
                                const data = studentData.grades[subject];
                                const tr = document.createElement('tr');
                                const subj = subject.charAt(0).toUpperCase() + subject.slice(1);
                                const score = data.score || '';
                                const grade = data.grade || '';
                                tr.innerHTML = `<td>${subj}</td><td>${score}</td><td><span class="grade-badge">${grade}</span></td>`;
                                tbody.appendChild(tr);
                            });
                        } else {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td colspan="3">No grades found for <strong>${studentData.name}</strong>. It looks like your teacher hasn't added marks yet.</td>`;
                            tbody.appendChild(tr);
                        }
                        renderGradesChart();
                    }
                    updateRecentGrades();

                    // Render a small chart if Chart.js is available and we have numeric scores
                    function renderGradesChart() {
                        const canvas = document.getElementById('gradesChart');
                        if (!canvas) return;
                        const scores = [];
                        const labels = [];
                        if (studentData.grades && Object.keys(studentData.grades).length > 0) {
                            const keys = Object.keys(studentData.grades).slice(-6);
                            keys.forEach(k => {
                                const s = studentData.grades[k].score || '0';
                                const n = parseInt(s.toString().replace('%','')) || 0;
                                scores.push(n);
                                labels.push(k.charAt(0).toUpperCase()+k.slice(1));
                            });
                        }

                        // wait for Chart to load
                        const tryRender = () => {
                            if (typeof Chart === 'undefined') { setTimeout(tryRender, 120); return; }
                            if (scores.length === 0) {
                                // clear canvas
                                const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); return;
                            }
                            canvas.style.display = 'block';
                            const ctx = canvas.getContext('2d');
                            // destroy previous chart if exists
                            if (canvas._chart) { canvas._chart.destroy(); }
                            canvas._chart = new Chart(ctx, {
                                type: 'line',
                                data: { labels: labels, datasets: [{ data: scores, borderColor: '#2c8c3a', backgroundColor: 'rgba(44,140,58,0.08)', tension:0.4, fill:true, pointRadius:2 }] },
                                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} }
                            });
                        };
                        tryRender();
                    }

                    const subjectSearchForm = document.getElementById('subjectSearchForm');
                    if (subjectSearchForm) {
                        subjectSearchForm.addEventListener('submit', function(event) {
                            event.preventDefault();
                            const subjectInput = document.getElementById('subject-search').value.trim().toLowerCase();
                            const searchResultsDiv = document.getElementById('searchResults');
                            searchResultsDiv.innerHTML = '';
                            const result = studentData.grades[subjectInput];
                            
                            if (result) {
                                searchResultsDiv.innerHTML = `<p class="search-result-found">Your grade for <strong>${subjectInput.charAt(0).toUpperCase() + subjectInput.slice(1)}</strong> is: ${result.score} (${result.grade})</p>`;
                            } else {
                                searchResultsDiv.innerHTML = `<p class="search-result-not-found">No grade found for "${subjectInput}". Please check the subject name.</p>`;
                            }
                        });
                    }

                    function getInterviewSuggestion() {
                        const interviewSubjects = {
                            'programming': 'Programming',
                            'physics': 'Physics',
                            'math': 'Mathematics'
                        };
                        const interviewSuggestionDiv = document.getElementById('interviewSuggestion');
                        const suggestions = [];

                                if (!studentData.grades || Object.keys(studentData.grades).length === 0) {
                                    // When there are no grades, show a clear message and do not surface any "random" interview report text
                                    interviewSuggestionDiv.innerHTML = `<p class="card-text">No grades have been added for <strong>${studentData.name}</strong>. Your teacher has not uploaded marks yet.</p>`;
                                    return;
                                }

                        for (const subject in interviewSubjects) {
                            const grade = studentData.grades[subject];
                            if (grade) {
                                const gradeValue = parseInt(grade.score);
                                if (gradeValue < 80) {
                                    suggestions.push(interviewSubjects[subject]);
                                }
                            }
                        }

                        if (suggestions.length === 0) {
                            interviewSuggestionDiv.innerHTML = `<p class="card-text">Based on your core engineering grades, you are **well-prepared** for an interview! Keep up the great work. ðŸŽ‰</p><a href="#" class="btn btn-small">Practice Now</a>`;
                        } else {
                            const weakSubjects = suggestions.join(', ');
                            interviewSuggestionDiv.innerHTML = `<p class="card-text">To prepare for interviews, you should focus on improving your knowledge in: **${weakSubjects}**.</p><a href="#" class="btn btn-small">Practice Now</a>`;
                        }
                    }
                    getInterviewSuggestion();

                    const overallGradeEl = document.getElementById('overallGrade');
                    const overallMessageEl = document.querySelector('#overallGrade + .card-text'); 
                    let totalScore = 0;
                    let subjectCount = 0;

                    if (studentData.grades && Object.keys(studentData.grades).length > 0) {
                        for (const subject in studentData.grades) {
                            totalScore += parseInt(studentData.grades[subject].score); 
                            subjectCount++;
                        }
                        const average = totalScore / subjectCount;
                        
                        if (average >= 90) { overallGradeEl.textContent = 'A+'; overallMessageEl.textContent = 'Outstanding!'; }
                        else if (average >= 85) { overallGradeEl.textContent = 'A'; overallMessageEl.textContent = 'Excellent!'; }
                        else if (average >= 80) { overallGradeEl.textContent = 'B+'; overallMessageEl.textContent = 'Great work!'; }
                        else if (average >= 75) { overallGradeEl.textContent = 'B'; overallMessageEl.textContent = 'Good job!'; }
                        else if (average >= 70) { overallGradeEl.textContent = 'C+'; overallMessageEl.textContent = 'Solid effort.'; }
                        else if (average >= 60) { overallGradeEl.textContent = 'D'; overallMessageEl.textContent = 'Needs improvement.'; }
                        else { overallGradeEl.textContent = 'F'; overallMessageEl.textContent = 'At risk.'; }
                    } else {
                        overallGradeEl.textContent = 'N/A';
                        overallMessageEl.textContent = `No grades found for ${studentData.name}. Please ask your teacher to add marks.`;
                    }

                } else {
                    alert(serverResponse.message);
                    localStorage.removeItem('userEmail');
                    window.location.href = 'login.html';
                }

            } catch (error) {
                console.error('Error fetching profile:', error);
                alert('Could not connect to the server. Is it running?');
                window.location.href = 'login.html';
            }

            const logoutLink = document.getElementById('logout-link');
            if (logoutLink) {
                logoutLink.addEventListener('click', (event) => {
                    event.preventDefault(); 
                    localStorage.removeItem('userEmail');
                    alert('You have been logged out.');
                    window.location.href = 'login.html';
                });
            }
        });
    </script>
</body>
</html>