<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher Dashboard - Eduwise (Local)</title>
  <link rel="stylesheet" href="index.css">
  <!-- dashboard.css removed (consolidated into teacher_dashboard.css) -->
  <link rel="stylesheet" href="teacher_dashboard.css">
  <!-- shared/button styles consolidated into teacher_dashboard.css; keep a print stylesheet for printing -->
  <link rel="stylesheet" href="print.css" media="print">
  <!-- buttons-control removed per user request -->
  <!-- Local-only teacher dashboard: no external fonts or CDNs -->
</head>
<body>
  <div class="dashboard-wrapper">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="index.html" class="logo-link">
          <img src="logo.jpg" alt="Eduwise Logo" class="logo-img">
          <span>Eduwise</span>
        </a>
      </div>
      <nav class="sidebar-nav">
        <h3 class="menu-heading">Main</h3>
        <ul class="sidebar-menu">
          <li class="menu-item"><a href="teacher_dashboard.html">Dashboard</a></li>
        </ul>
        <h3 class="menu-heading">Forms</h3>
        <ul class="sidebar-menu">
          <li class="menu-item"><button id="sidebarAddStudent" class="action-btn btn-small btn-ghost">Add Student</button></li>
          <li class="menu-item"><button id="sidebarAddGrade" class="action-btn btn-small btn-ghost">Add Grade</button></li>
          <li class="menu-item"><button id="sidebarGenerateReport" class="action-btn btn-small btn-ghost">Generate Report</button></li>
        </ul>
        <h3 class="menu-heading">Views</h3>
        <ul class="sidebar-menu">
          <li class="menu-item"><a href="#">All Students</a></li>
          <li class="menu-item"><button id="sidebarStudentPerformance" class="action-btn btn-small btn-ghost">Student Performance</button></li>
          <li class="menu-item"><button id="sidebarInterviewReport" class="action-btn btn-small btn-ghost">Interview Reports</button></li>
        </ul>
      </nav>
    </aside>

    <div class="main-content-area">
      <header class="main-header">
        <div class="main-header-content">
          <div class="header-left">
            <h1 class="page-title">Teacher Dashboard</h1>
          </div>
          <div class="header-right">
            <span id="teacherInfo">Welcome, <strong id="teacherName">Teacher</strong></span>
            <button id="logoutBtn" class="btn-small btn-ghost" style="margin-left:8px">Logout</button>
          </div>
        </div>
      </header>

      <main class="dashboard-main">
        <div class="summary-grid">
          <div class="summary-card bg-blue">
            <div class="summary-icon">üë•</div>
            <div class="summary-details"><span class="summary-value" id="totalStudentsCount">0</span><span class="summary-label">Total Students</span></div>
          </div>
          <div class="summary-card bg-green">
            <div class="summary-icon">üìÑ</div>
            <div class="summary-details"><span class="summary-value" id="totalReportsCount">0</span><span class="summary-label">Reports Generated</span></div>
          </div>
          <div class="summary-card bg-primary">
            <div class="summary-icon">‚≠ê</div>
            <div class="summary-details"><span class="summary-value" id="recommendedCount">0</span><span class="summary-label">Recommended for Interview</span></div>
          </div>
          <div class="summary-card bg-yellow">
            <div class="summary-icon">‚ö†Ô∏è</div>
            <div class="summary-details"><span class="summary-value" id="cautionCount">0</span><span class="summary-label">Needs Improvement</span></div>
          </div>
        </div>

        <div class="dashboard-controls">
          <button id="addStudentBtn" class="action-btn add-btn">Add New Student</button>
          <button id="generateReportBtn" class="action-btn">Generate Report</button>
        </div>

        <div id="studentCardGrid" class="card-grid"></div>
      </main>
    </div>
  </div>

  <!-- Edit Modal (simpler local version) -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="edit-close-btn">&times;</span>
      <h2 id="modalTitle">Edit Student Profile</h2>
      <form id="editForm" class="edit-form">
        <div class="modal-body single-col">
          <input type="hidden" id="editStudentId"> <!-- original email stored here -->
          <div class="form-group"><label>Full Name</label><input id="editFullName" type="text" required></div>
          <div class="form-group"><label>Student Email (Login ID)</label><input id="editEmail" type="email" required></div>
          <div class="form-group"><label>Student ID</label><input id="editSchoolId" type="text"></div>
          <div class="form-group"><label>Phone Number</label><input id="editPhone" type="tel"></div>
          <div class="form-group"><label>Temporary Password (leave blank to keep)</label><input id="editPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>

          <h3>Subject Grades</h3>
          <div id="dynamicSubjectInputs"></div>
          <div class="form-group add-subject-group"><input id="newSubjectName" placeholder="New Subject Name"><input id="newSubjectGrade" placeholder="Score (e.g., 88)"><button type="button" id="addNewSubjectBtn" class="action-btn">Add Subject</button></div>

          <h3>Interview Report</h3>
          <div class="form-group"><textarea id="interviewReport" rows="4" placeholder="Add custom report..."></textarea></div>
        </div>
        <button type="submit" class="action-btn save-btn">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toastContainer" aria-live="polite" aria-atomic="true" style="position:fixed;right:16px;bottom:16px;z-index:9999;display:flex;flex-direction:column;gap:8px"></div>

  <!-- Student selector modal (searchable list) -->
  <div id="studentSelectorModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="studentSelectorClose">&times;</span>
      <h3>Select Student</h3>
      <div style="margin:12px 0">
        <input id="studentSelectorSearch" placeholder="Enter student name to view interview report (leave blank to see instructions)" style="width:100%;padding:10px;border:1px solid #e6e7eb;border-radius:8px" />
        <div id="studentSelectorInstructions" style="margin-top:8px;color:#6b7280;font-size:13px;display:none">Leave the field empty and press Enter to see instructions on using Interview Reports. Otherwise type a student name and select from the list.</div>
      </div>
      <div id="studentSelectorList" style="max-height:320px;overflow:auto"></div>
    </div>
  </div>

  <!-- Add Student Modal -->
  <div id="addStudentModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="add-close-btn">&times;</span>
      <h2>Add New Student</h2>
      <form id="addStudentForm" class="edit-form">
        <div class="modal-body single-col">
          <div class="form-group"><label>Full Name</label><input id="addFullName" required></div>
          <div class="form-group"><label>Student Email (Login ID)</label><input id="addEmail" class="input-light" type="email" required></div>
          <div class="form-group"><label>Student ID</label><input id="addSchoolId" required></div>
          <div class="form-group"><label>Phone Number</label><input id="addPhone"></div>
          <div class="form-group"><label>Temporary Password</label><input id="addPassword" class="input-light" type="password"></div>
          <p id="addStudentError" class="error-message" style="color:red;display:none"></p>
        </div>
        <button type="submit" class="action-btn save-btn create-cta">Create Student Account</button>
      </form>
    </div>
  </div>

  <!-- Analytics Modal -->
  <div id="analyticsModal" class="modal">
    <div class="modal-content modal-large">
      <span class="close-btn" id="analytics-close-btn">&times;</span>
      <div class="modal-header">
        <h2 id="analyticsModalTitle">Analytics</h2>
        <div class="analytics-controls" style="margin-left:24px;display:flex;gap:10px;align-items:center">
          <label style="font-size:13px;color:#6b7280;margin-right:6px">Chart</label>
          <select id="chartTypeSelect" class="small-select" aria-label="Chart type"></select>
          <label style="font-size:13px;color:#6b7280;margin-right:6px;margin-left:6px">Subject</label>
          <select id="subjectSelect" class="small-select" aria-label="Subject filter"></select>
          <label style="font-size:13px;color:#6b7280;margin-right:6px;margin-left:6px">Limit</label>
          <select id="topNSelect" class="small-select" aria-label="Top N"></select>
          <label id="studentSelectLabel" style="font-size:13px;color:#6b7280;margin-right:6px;margin-left:6px;display:none">Student</label>
          <select id="studentSelect" class="small-select" aria-label="Student selector" style="display:none"></select>
        </div>
      </div>
      <div class="modal-body">
        <div>
          <p id="analyticsChartSubtitle" class="chart-subtitle"></p>
          <div class="chart-container">
            <canvas id="analyticsChart" width="800" height="320"></canvas>
            <div id="chartPlaceholder" class="chart-placeholder" style="display:none">
              <div class="placeholder-inner">
                <div class="placeholder-illustration">üìä</div>
                <div class="placeholder-text">No chart data yet ‚Äî add grades or select a student to populate this chart.</div>
              </div>
            </div>
          </div>
        </div>
        <div>
          <div id="analyticsStudentSummary" class="student-summary">
            <!-- Populated dynamically with selected student's quick info -->
          </div>
          <div id="analyticsReportText" class="report-text-analysis"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Local-only teacher dashboard script (cleaned and complete)
    let students = [];
    let analyticsChartInstance = null;

    // API base: can be set by `api-config.js` (window.__API_BASE__), otherwise fallback to localhost for dev
    const API_BASE = (window.__API_BASE__ && window.__API_BASE__.trim()) ? window.__API_BASE__.trim() : 'http://localhost:3000';
    function isServerMode(){ return localStorage.getItem('useServer') === 'true'; }

    async function fetchStudentsFromServer(){
      try{
        const resp = await fetch(`${API_BASE}/api/get-all-students`,{ method:'GET', headers:{'Accept':'application/json'} });
        const j = await resp.json();
        if(j && j.success && Array.isArray(j.students)) return j.students;
        return [];
      } catch(err){ console.error('fetchStudentsFromServer error', err); return null; }
    }

    async function addStudentToServer(student){
      try{
        const resp = await fetch(`${API_BASE}/api/teacher-add-student`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(student) });
        const j = await resp.json(); return j;
      } catch(err){ console.error('addStudentToServer error', err); return { success:false, message: 'Network error' }; }
    }

    async function updateStudentOnServer(email, newGrades, newInterviewReport){
      try{
        const resp = await fetch(`${API_BASE}/api/update-student-data`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, newGrades, newInterviewReport }) });
        const j = await resp.json(); return j;
      } catch(err){ console.error('updateStudentOnServer error', err); return { success:false, message:'Network error' }; }
    }

    function getUsersFromLocal(){ try { return JSON.parse(localStorage.getItem('users')||'[]'); } catch(e){ return []; } }

    function getInterviewRecommendation(student){
      const grades = student.grades || {};
      if(!grades || Object.keys(grades).length===0) return { text: 'No grades added yet.', status: 'na' };
      const engineeringSubjects = ['math','physics','programming','chemistry'];
      const minPassing = 75; let good=0, total=0;
      for(const s of Object.keys(grades)){
        const v = parseInt(grades[s].score);
        if(isNaN(v)) continue;
        if(engineeringSubjects.includes(s.toLowerCase())){ total++; if(v>=minPassing) good++; }
      }
      if(total===0) return { text:'No core engineering grades.', status:'na'};
      const pct = (good/total)*100; if(pct>=80) return {text:'Highly Recommended', status:'high'}; if(pct>=50) return {text:'Recommended with Caution', status:'medium'}; return {text:'Not Recommended', status:'low'};
    }

    async function loadDashboardData(){
      // If server-mode is enabled, fetch from API
      if(isServerMode()){
        const srv = await fetchStudentsFromServer();
        if(srv === null){
          showToast('Could not reach server ‚Äî switching to local mode','error');
          localStorage.setItem('useServer','false');
        } else {
          // Map server student objects to local shape
          students = (srv||[]).map((s, i) => ({ id: s.id || s.schoolId || ('s'+(i+1)), name: s.name || s.full_name || s.fullName || s.email, email: s.email||'', grades: s.grades||{}, interviewReport: s.interviewReport||s.interview_report||'' }));
          renderCards(students);
          updateSummaryCards();
          // teacher info: prefer localStorage.userEmail if set
          const email = localStorage.getItem('userEmail') || '';
          document.getElementById('teacherName').textContent = email || 'Teacher';
          return;
        }
      }

      // Local fallback
      const all = getUsersFromLocal();
      students = all.filter(u => (u.userType||'').toLowerCase() === 'student').map((u, i) => ({ id: u.schoolId||('s'+(i+1)), name: u.fullName||u.name||u.email, email: u.email||'', grades: u.grades||{}, interviewReport: u.interviewReport||'' }));
      renderCards(students);
      updateSummaryCards();
      const email = localStorage.getItem('userEmail'); const me = getUsersFromLocal().find(x=>x.email===email);
      document.getElementById('teacherName').textContent = me ? (me.fullName||me.email) : 'Teacher';
    }

    function updateSummaryCards(){
      const reports = students.filter(s=> s.interviewReport && s.interviewReport.length>0).length;
      const recommended = students.filter(s=> getInterviewRecommendation(s).status==='high').length;
      const needs = students.filter(s=> ['low','medium'].includes(getInterviewRecommendation(s).status)).length;
      document.getElementById('totalStudentsCount').textContent = students.length;
      document.getElementById('totalReportsCount').textContent = reports;
      document.getElementById('recommendedCount').textContent = recommended;
      document.getElementById('cautionCount').textContent = needs;
    }

    function renderCards(data){
      const grid = document.getElementById('studentCardGrid'); grid.innerHTML='';
      data.forEach(student=>{
        const rec = getInterviewRecommendation(student);
        const card = document.createElement('div'); card.className='card student-card'; card.dataset.email = student.email;
        let gradeList = '<li>No grades added.</li>';
        if(student.grades && Object.keys(student.grades).length>0){ gradeList = Object.entries(student.grades).map(([k,v])=>`<li><strong>${k}:</strong> ${v.score} (${v.grade||''})</li>`).join(''); }
        card.innerHTML = `
          <div class="card-body">
            <div class="student-info"><p class="student-id">${student.id}</p><h3 class="student-name">${student.name}</h3></div>
            <div class="recommendation-badge recommendation-${rec.status}">${rec.text}</div>
            <div class="actions"><button class="action-btn edit-btn" data-email="${student.email}">Edit</button><button class="action-btn report-btn interview-report-btn" data-email="${student.email}">View Report</button></div>
            <button class="accordion-btn"><span class="accordion-text">Show All Grades</span><span class="accordion-icon">‚ñæ</span></button>
            <div class="accordion-panel"><ul class="grade-list">${gradeList}</ul></div>
          </div>`;
        grid.appendChild(card);
      });
      updateSummaryCards();
    }

    // DOM events
    document.addEventListener('click', function(e){
      if(e.target.classList.contains('edit-btn')){
        const email = e.target.dataset.email; const student = students.find(s=>s.email===email); if(!student) return;
        document.getElementById('modalTitle').textContent='Edit Student';
        document.getElementById('editStudentId').value = student.email; // original key
        // populate editable fields
        document.getElementById('editFullName').value = student.name || student.fullName || '';
        document.getElementById('editEmail').value = student.email || '';
        document.getElementById('editSchoolId').value = student.id || student.schoolId || '';
        document.getElementById('editPhone').value = student.phoneNumber || '';
        document.getElementById('editPassword').value = '';
        populateModalGrades(student.grades);
        document.getElementById('interviewReport').value = student.interviewReport||'';
        document.getElementById('editModal').style.display='flex';
      }
      if(e.target.classList.contains('accordion-btn')){
        const btn = e.target; const panel = btn.nextElementSibling; btn.classList.toggle('active'); if(panel.style.maxHeight){ panel.style.maxHeight = null; btn.querySelector('.accordion-text').textContent='Show All Grades'; } else { panel.style.maxHeight = panel.scrollHeight + 'px'; btn.querySelector('.accordion-text').textContent='Hide All Grades'; }
      }
      if(e.target.classList.contains('interview-report-btn')){
        const email = e.target.dataset.email; const student = students.find(s=>s.email===email); if(student) showInterviewReport(student);
      }
    });

    // Search and controls
    document.getElementById('addStudentBtn').addEventListener('click', ()=>{ document.getElementById('addStudentForm').reset(); document.getElementById('addStudentError').style.display='none'; document.getElementById('addStudentModal').style.display='flex'; });
    document.getElementById('sidebarAddStudent').addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('addStudentBtn').click(); });
    document.getElementById('sidebarGenerateReport').addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('generateReportBtn').click(); });

    // Sidebar: Add Grade -> open student selector (searchable)
    document.getElementById('sidebarAddGrade').addEventListener('click', (e)=>{
      e.preventDefault();
      openStudentSelector((student)=>{
        if(!student) return;
        document.getElementById('modalTitle').textContent = 'Edit Student Grades';
        document.getElementById('editStudentId').value = student.email;
        populateModalGrades(student.grades);
        document.getElementById('interviewReport').value = student.interviewReport || '';
        document.getElementById('editModal').style.display = 'flex';
      });
    });

    // Sidebar: Interview Report -> prompt or instruct and open report for a chosen student
    document.getElementById('sidebarInterviewReport').addEventListener('click', (e)=>{
      e.preventDefault();
      openStudentSelector((student)=>{
        if(!student){ showToast('No student selected','info'); return; }
        showInterviewReport(student);
      });
    });

    // Sidebar: Student Performance -> open analytics as an overview
    const spBtn = document.getElementById('sidebarStudentPerformance');
    if(spBtn){
      spBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        // prepare modal for overall student performance
        document.getElementById('analyticsModalTitle').textContent = 'Student Performance Analytics';
        document.getElementById('analyticsChartSubtitle').textContent = 'Overall average scores across all subjects, sorted high-to-low.';
        // set a friendly dataset label used by Chart.js
        window.analyticsDatasetLabel = 'Overall Student Average (%)';
        renderAnalyticsControls();
        generateAnalyticsChart();
        document.getElementById('analyticsModal').style.display = 'flex';
      });
    }

    document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('userEmail'); window.location.href='login.html'; });

    // (header quick-add removed) ‚Äî Add Student is available via page controls and sidebar

    // Add Student (local)
    document.getElementById('addStudentForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const err = document.getElementById('addStudentError'); err.style.display='none';
      const student = {
        fullName: document.getElementById('addFullName').value.trim(),
        email: (document.getElementById('addEmail').value||'').trim().toLowerCase(),
        schoolId: document.getElementById('addSchoolId').value.trim(),
        phoneNumber: document.getElementById('addPhone').value.trim(),
        password: document.getElementById('addPassword').value
      };
      if(!student.email||!student.fullName){ err.textContent='Name and email required'; err.style.display='block'; return; }

      if(isServerMode()){
        // Call backend
        const resp = await addStudentToServer({ email: student.email, fullName: student.fullName, schoolId: student.schoolId, phoneNumber: student.phoneNumber, password: student.password });
        if(resp && resp.success){ showToast('Student created on server','success'); document.getElementById('addStudentModal').style.display='none'; await loadDashboardData(); }
        else { err.textContent = resp && resp.message ? resp.message : 'Failed to create student on server'; err.style.display='block'; }
        return;
      }

      // Local mode
      const users = getUsersFromLocal();
      if(users.find(u=> (u.email||'').toLowerCase()===student.email)){ err.textContent='User exists'; err.style.display='block'; return; }
      users.push({ email: student.email, fullName: student.fullName, schoolId: student.schoolId||('s'+(users.length+1)), phoneNumber: student.phoneNumber||'', password: student.password||'', userType: 'student', grades: {}, interviewReport: '' });
      localStorage.setItem('users', JSON.stringify(users));
      showToast('Student added locally', 'success');
      document.getElementById('addStudentModal').style.display='none';
      await loadDashboardData();
    });

    // Populate modal grades
    function populateModalGrades(grades){ const container = document.getElementById('dynamicSubjectInputs'); container.innerHTML=''; if(!grades||Object.keys(grades).length===0){ container.innerHTML='<p style="text-align:center;color:#666">No grades yet.</p>'; return; } for(const subject in grades){ const g = grades[subject]; const group = document.createElement('div'); group.className='form-group grade-input-group'; group.innerHTML = `<input class="subject-name-input" value="${subject}" data-subject-name="${subject}" readonly><input class="grade-score-input" value="${g.score}" data-subject-score="${subject}" placeholder="Score"><input class="grade-letter-input" value="${g.grade||''}" data-subject-grade="${subject}" placeholder="Grade">`; container.appendChild(group); } }

    document.getElementById('addNewSubjectBtn').addEventListener('click', function(){
      const name = (document.getElementById('newSubjectName').value||'').trim().toLowerCase();
      const score = (document.getElementById('newSubjectGrade').value||'').trim();
      if(!name||!score){ showToast('Enter subject and score','error'); return; }
      const container = document.getElementById('dynamicSubjectInputs'); const no = container.querySelector('p'); if(no) no.remove(); const group = document.createElement('div'); group.className='form-group grade-input-group'; group.innerHTML = `<input class="subject-name-input" value="${name}" data-subject-name="${name}" readonly><input class="grade-score-input" value="${score}" data-subject-score="${name}" placeholder="Score"><input class="grade-letter-input" value="" data-subject-grade="${name}" placeholder="Grade">`; container.appendChild(group); document.getElementById('newSubjectName').value=''; document.getElementById('newSubjectGrade').value=''; showToast('Subject added to editor','success'); });

    // Save edits (local)
    document.getElementById('editForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const originalEmail = document.getElementById('editStudentId').value;
      const fullName = (document.getElementById('editFullName').value||'').trim();
      const newEmail = (document.getElementById('editEmail').value||'').trim().toLowerCase();
      const schoolId = (document.getElementById('editSchoolId').value||'').trim();
      const phone = (document.getElementById('editPhone').value||'').trim();
      const newPassword = (document.getElementById('editPassword').value||'').trim();
      const customReport = document.getElementById('interviewReport').value;
      const newGrades = {};
      const scoreInputs = document.querySelectorAll('#dynamicSubjectInputs input[data-subject-score]');
      const gradeInputs = document.querySelectorAll('#dynamicSubjectInputs input[data-subject-grade]');
      const nameInputs = document.querySelectorAll('#dynamicSubjectInputs input.subject-name-input');
      for(let i=0;i<scoreInputs.length;i++){
        const subj = (nameInputs[i].dataset.subjectName||nameInputs[i].value.trim()).toLowerCase();
        const score = scoreInputs[i].value.trim();
        let grade = gradeInputs[i].value.trim();
        if(subj && score){
          if(!grade){
            const sc = parseInt(score);
            if(sc>=90) grade='A'; else if(sc>=80) grade='B'; else if(sc>=70) grade='C'; else if(sc>=60) grade='D'; else grade='F';
            gradeInputs[i].value = grade;
          }
          newGrades[subj] = { score: score, grade: grade };
        }
      }
      try{
        // Server mode: update via API
        if(isServerMode()){
          // If email changed, we do not attempt to rename via this endpoint ‚Äî block for safety
          if(newEmail && newEmail !== (originalEmail||'').toLowerCase()){
            showToast('Changing email is not supported in server mode. Edit locally or contact admin.','error');
            return;
          }
          const resp = await updateStudentOnServer(originalEmail, newGrades, customReport);
          if(resp && resp.success){ showToast('Saved on server','success'); document.getElementById('editModal').style.display='none'; await loadDashboardData(); }
          else { showToast(resp && resp.message ? resp.message : 'Failed to save on server','error'); }
          return;
        }

        // Local fallback
        const users = getUsersFromLocal();
        const idx = users.findIndex(u=> (u.email||'').toLowerCase() === (originalEmail||'').toLowerCase());
        if(idx===-1){ showToast('Student not found','error'); return; }

        // Prevent duplicate email if changed
        if(newEmail && newEmail !== (originalEmail||'').toLowerCase()){
          const other = users.find(u=> (u.email||'').toLowerCase() === newEmail);
          if(other){ showToast('Email already in use','error'); return; }
        }

        // Update fields
        users[idx].fullName = fullName || users[idx].fullName || users[idx].name;
        if(newEmail) users[idx].email = newEmail;
        if(schoolId) users[idx].schoolId = schoolId;
        if(phone) users[idx].phoneNumber = phone;
        if(newPassword) users[idx].password = newPassword;

        // Merge grades and report
        users[idx].grades = Object.assign({}, users[idx].grades||{}, newGrades);
        users[idx].interviewReport = customReport || users[idx].interviewReport || '';

        localStorage.setItem('users', JSON.stringify(users));
        showToast('Saved locally','success');
        document.getElementById('editModal').style.display='none';
        await loadDashboardData();
      } catch(err){ console.error(err); showToast('Failed to save locally','error'); }
    });

    // Generate analytics chart (fallback if Chart.js not available)
    function getAvailableSubjects(){
      const s = new Set();
      students.forEach(st=>{ if(st.grades){ Object.keys(st.grades).forEach(k=>s.add(k)); } });
      return Array.from(s).sort();
    }

    function renderAnalyticsControls(){
      const ct = document.getElementById('chartTypeSelect');
      const ss = document.getElementById('subjectSelect');
      const tn = document.getElementById('topNSelect');
      const studentSel = document.getElementById('studentSelect');
      const studentLabel = document.getElementById('studentSelectLabel');
      if(!ct||!ss||!tn) return;
      // chart types
      ct.innerHTML = '<option value="bar">Bar</option><option value="line">Line</option><option value="radar">Radar</option>';
      // subjects
      const subs = getAvailableSubjects();
      ss.innerHTML = '<option value="Overall">Overall</option>' + subs.map(x=>`<option value="${x}">${x.charAt(0).toUpperCase()+x.slice(1)}</option>`).join('');
      // top N (default Top 10)
      tn.innerHTML = '<option value="0">All</option><option value="5">Top 5</option><option value="10" selected>Top 10</option><option value="20">Top 20</option>';
      // student selector: populate
      if(studentSel){
        const stOpts = students.map(s=>`<option value="${s.email}">${s.name}</option>`).join('');
        studentSel.innerHTML = '<option value="">(select student)</option>' + stOpts;
      }
      // attach listeners
      [ct,ss,tn].forEach(el=> el.onchange = ()=>{ window.analyticsChartType = ct.value; window.analyticsSubject = ss.value; window.analyticsTopN = parseInt(tn.value)||0; // show/hide student selector when radar selected
        if(window.analyticsChartType === 'radar'){
          if(studentSel){ studentSel.style.display='inline-block'; studentLabel.style.display='inline-block'; }
        } else { if(studentSel){ studentSel.style.display='none'; studentLabel.style.display='none'; } }
        generateAnalyticsChart(); });
      // student select change: redraw as a single-student radar
      if(studentSel){ studentSel.onchange = ()=>{ window.analyticsSelectedStudent = studentSel.value || null; generateAnalyticsChart(); }; }
      window.analyticsChartType = ct.value; window.analyticsSubject = ss.value; window.analyticsTopN = parseInt(tn.value)||0; window.analyticsSelectedStudent = (studentSel && studentSel.value) || null;
    }

    function generateAnalyticsChart(){
      const canvas = document.getElementById('analyticsChart');
      const ctx = canvas.getContext('2d');
      let chartType = window.analyticsChartType || 'bar';
      let subject = window.analyticsSubject || 'Overall';
      let topN = window.analyticsTopN || 0;

      // prepare data depending on subject selection
      let labels = [];
      let data = [];

      if(subject === 'Overall'){
        // per-student average across subjects
        let arr = students.map(s=>{ let total=0,count=0; for(const k in s.grades){ const v = parseInt(s.grades[k].score); if(!isNaN(v)){ total+=v; count++; } } return { name: s.name, avg: count? (total/count):0, grades: s.grades, id: s.id } });
        arr.sort((a,b)=>b.avg-a.avg);
        if(topN>0) arr = arr.slice(0, topN);
        labels = arr.map(a=>a.name);
        data = arr.map(a=>a.avg);
        // special handling for radar: show per-subject averages across the selected top students
        if(chartType === 'radar'){
          const subs = getAvailableSubjects();
          labels = subs.map(s=>s.charAt(0).toUpperCase()+s.slice(1));
          const values = subs.map(sub=>{
            let tot=0,cnt=0;
            arr.forEach(st=>{ if(st.grades && st.grades[sub]){ const v = parseInt(st.grades[sub].score); if(!isNaN(v)){ tot+=v; cnt++; } } });
            return cnt? Math.round(tot/cnt):0;
          });
          data = values;
        }
      } else {
        // per-student score for a specific subject
        let arr = students.map(s=>({ name: s.name, val: (s.grades && s.grades[subject])? (parseInt(s.grades[subject].score)||0):0 }));
        arr.sort((a,b)=>b.val-a.val);
        if(topN>0) arr = arr.slice(0, topN);
        labels = arr.map(a=>a.name);
        data = arr.map(a=>a.val);
        // radar is allowed: it will show students as axes
        if(chartType === 'radar'){
          // labels already students; leave as-is
        }
      }

      // show/hide placeholder
      const placeholder = document.getElementById('chartPlaceholder');
      if((!data || data.length===0 || data.every(v=>v===0))){
        if(placeholder){ placeholder.style.display = 'flex'; }
        if(canvas) canvas.style.display = 'none';
      } else {
        if(placeholder) placeholder.style.display = 'none';
        if(canvas) canvas.style.display = 'block';
      }

      // draw using Chart.js if available
      if(window.Chart){
        if(analyticsChartInstance) analyticsChartInstance.destroy();
        analyticsChartInstance = new Chart(ctx, {
          type: chartType === 'radar' ? 'radar' : (chartType === 'bar' ? 'bar' : 'line'),
          data: {
            labels: labels,
            datasets: [{ label: (window.analyticsDatasetLabel || 'Overall Student Average (%)'), data: data, borderColor: 'rgb(75,192,192)', backgroundColor: 'rgba(75,192,192,0.2)', fill: chartType !== 'bar' }]
          },
          options: { responsive:true, maintainAspectRatio:false, scales: { y: { beginAtZero:true, max:100 } } }
        });
      } else {
        // fallback renderer when Chart.js is not available
        if(chartType === 'bar'){
          drawBarFallback('analyticsChart', labels, data);
        } else if(chartType === 'line'){
          drawSimpleLineChart(canvas, labels, data);
        } else {
          // radar or unknown -> use a simple line fallback as a graceful degradation
          drawSimpleLineChart(canvas, labels, data);
        }
      }
    }

    function drawSimpleLineChart(canvas, labels, data){
      const dpr = window.devicePixelRatio||1;
      const cssW = canvas.clientWidth||canvas.width;
      const cssH = canvas.clientHeight||canvas.height;
      canvas.width = Math.round(cssW*dpr);
      canvas.height = Math.round(cssH*dpr);
      canvas.style.width = cssW+'px';
      canvas.style.height = cssH+'px';
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,cssW,cssH);
      if(!labels.length){ ctx.fillStyle='#666'; ctx.font='14px sans-serif'; ctx.fillText('No data',10,24); return; }
      const pad=40; const w = cssW-pad*2; const h = cssH-pad*2; const max = Math.max(100, ...data);
      // Y grid lines
      ctx.strokeStyle='#f1f5f9'; ctx.lineWidth=1;
      for(let yTick=0;yTick<=5;yTick++){ const yy = pad + (yTick/5)*h; ctx.beginPath(); ctx.moveTo(pad, yy); ctx.lineTo(pad+w, yy); ctx.stroke(); }
      // axes
      ctx.strokeStyle='#e6e7eb'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, pad+h); ctx.lineTo(pad+w, pad+h); ctx.stroke();
      // draw line points
      ctx.strokeStyle='#0ea5a0'; ctx.lineWidth=2; ctx.beginPath(); data.forEach((v,i)=>{ const x = pad + (i/(data.length-1||1))*w; const y = pad + h - ((v)/(max||1))*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();
      // draw dots
      data.forEach((v,i)=>{ const x = pad + (i/(data.length-1||1))*w; const y = pad + h - ((v)/(max||1))*h; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#0ea5a0'; ctx.lineWidth=2; ctx.stroke(); });
      // labels
      ctx.fillStyle='#222'; ctx.font='12px sans-serif'; labels.forEach((lbl,i)=>{ const x = pad + (i/(labels.length-1||1))*w; ctx.fillText(lbl, x-10, pad+h+18); });
    }

    // Interview report functions (reuse existing analysis)
    function analyzeStudentForInterview(grades){ const keySubjects=['programming','math','physics']; let strengths=[],weaknesses=[],chartData=[],numeric=[]; if(!grades||Object.keys(grades).length===0){ return { chartData:{ labels:keySubjects.map(s=>s.charAt(0).toUpperCase()+s.slice(1)), scores:[0,0,0] }, summary:'No grades available.', strengths:[], weaknesses:['No data.'], recommendation:'Not recommended.' }; } keySubjects.forEach(sub=>{ if(grades[sub]){ const score = parseInt(grades[sub].score)||0; chartData.push(score); numeric.push(score); if(score>=85) strengths.push(`${sub} (${score}%)`); else if(score<70) weaknesses.push(`${sub} (${score}%)`); } else { chartData.push(0); weaknesses.push(`No grade: ${sub}`); } }); const avg = numeric.length? numeric.reduce((a,b)=>a+b,0)/numeric.length : 0; let summary='', recommendation=''; if(avg>=85){ summary='Outstanding'; recommendation='Highly Recommended'; } else if(avg>=70){ summary='Solid performance'; recommendation='Recommended with caution'; } else { summary='Needs improvement'; recommendation='Not recommended'; } return { chartData:{ labels:keySubjects.map(s=>s.charAt(0).toUpperCase()+s.slice(1)), scores:chartData }, summary, strengths, weaknesses, recommendation }; }

    function renderChartOrPlaceholder(analysis){
      const canvas = document.getElementById('analyticsChart');
      const placeholder = document.getElementById('chartPlaceholder');
      const hasData = Array.isArray(analysis.chartData.scores) && analysis.chartData.scores.some(v=> v>0);
      if(!hasData){ // show placeholder
        placeholder.style.display = 'flex';
        canvas.style.display = 'none';
      } else {
        placeholder.style.display = 'none';
        canvas.style.display = 'block';
        const ctx = canvas.getContext('2d');
        if(window.Chart){ if(analyticsChartInstance) analyticsChartInstance.destroy(); analyticsChartInstance = new Chart(ctx, { type:'radar', data:{ labels: analysis.chartData.labels, datasets:[{ label:'Core Subject (%)', data: analysis.chartData.scores, backgroundColor:'rgba(33,150,243,0.15)', borderColor:'rgb(33,150,243)' }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ r:{ suggestedMin:0, suggestedMax:100 } } } }); }
        else { drawBarFallback('analyticsChart', analysis.chartData.labels, analysis.chartData.scores); }
      }
    }

    function showInterviewReport(student){
      const titleEl = document.getElementById('analyticsModalTitle');
      titleEl.textContent = `Interview Report for ${student.name}`;
      document.getElementById('analyticsChartSubtitle').textContent = `Core subjects performance for ${student.name}`;
      const analysis = analyzeStudentForInterview(student.grades);

      // populate student summary on the right
      const summaryEl = document.getElementById('analyticsStudentSummary');
      const shortHtml = `<div class="summary-card student-summary-card"><div class="student-avatar">${(student.name||'S').charAt(0).toUpperCase()}</div><div class="student-meta"><div class="student-name-small">${student.name}</div><div class="student-id-small">${student.id? '('+student.id+')':''}</div><div class="student-stats">Reports: <strong>${student.interviewReport?1:0}</strong> ‚Ä¢ Subjects: <strong>${Object.keys(student.grades||{}).length}</strong></div></div></div>`;
      summaryEl.innerHTML = shortHtml;

      renderChartOrPlaceholder(analysis);

      let html = `<h3>Summary</h3><p>${analysis.summary}</p><h4>Strengths</h4><ul>`;
      analysis.strengths.forEach(s=> html += `<li>${s}</li>`);
      html += `</ul><h4>Weaknesses</h4><ul>`;
      analysis.weaknesses.forEach(w=> html += `<li>${w}</li>`);
      html += `</ul><h4>Recommendation</h4><p>${analysis.recommendation}</p>`;
      document.getElementById('analyticsReportText').innerHTML = html;
      document.getElementById('analyticsModal').style.display='flex';
    }

    function drawRadarWithChart(chartData){ const ctx = document.getElementById('analyticsChart').getContext('2d'); if(analyticsChartInstance) analyticsChartInstance.destroy(); analyticsChartInstance = new Chart(ctx, { type:'radar', data:{ labels: chartData.labels, datasets:[{ label:'Core Subject (%)', data: chartData.scores, backgroundColor:'rgba(33,150,243,0.2)', borderColor:'rgb(33,150,243)' }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ r:{ suggestedMin:0, suggestedMax:100 } } } }); }

    function drawBarFallback(canvasId, labels, values){
      const canvas = document.getElementById(canvasId);
      const dpr = window.devicePixelRatio||1;
      const cssW = canvas.clientWidth||canvas.width;
      const cssH = canvas.clientHeight||canvas.height;
      canvas.width = Math.round(cssW*dpr);
      canvas.height = Math.round(cssH*dpr);
      canvas.style.width = cssW+'px';
      canvas.style.height = cssH+'px';
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,cssW,cssH);
      if(!labels || labels.length===0){ ctx.fillStyle='#666'; ctx.font='14px sans-serif'; ctx.fillText('No data',10,24); return; }
      const pad = 48;
      const w = cssW - pad*2;
      const h = cssH - pad*2;
      const max = Math.max(100, ...values);
      // draw y grid lines and ticks
      ctx.strokeStyle = '#f1f5f9'; ctx.lineWidth = 1;
      const ticks = 5;
      ctx.fillStyle = '#6b7280'; ctx.font='12px sans-serif';
      for(let i=0;i<=ticks;i++){
        const y = pad + (i/ticks)*h;
        ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(pad + w, y); ctx.stroke();
        const tickVal = Math.round(max * (1 - i/ticks));
        ctx.fillText(tickVal.toString(), 8, y+4);
      }
      // axes line
      ctx.strokeStyle = '#e6e7eb'; ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, pad+h); ctx.lineTo(pad + w, pad + h); ctx.stroke();
      // bars
      const barCount = values.length;
      const gapRatio = 0.2; // spacing between bars
      const totalGap = (barCount+1) * (gapRatio * w / Math.max(barCount,1));
      const availW = w - totalGap;
      const barW = Math.max(8, availW / Math.max(barCount,1));
      let x = pad + (gapRatio * w / Math.max(barCount,1));
      for(let i=0;i<barCount;i++){
        const val = values[i] || 0;
        const barH = (val / max) * h;
        const bx = x + i*(barW + (gapRatio * w / Math.max(barCount,1)));
        const by = pad + h - barH;
        // shadow / rounded bar
        ctx.fillStyle = 'rgba(34,197,94,0.9)';
        roundRect(ctx, bx, by, barW, barH, 6, true, false);
        // label
        ctx.fillStyle = '#222'; ctx.font='12px sans-serif'; const lbl = labels[i]; const txtW = ctx.measureText(lbl).width;
        const tx = bx + (barW/2) - (txtW/2);
        ctx.fillText(lbl, Math.max(pad, tx), pad + h + 16);
      }
      // helper: rounded rect
      function roundRect(ctx,x,y,w,h,r,fill,stroke){ if(typeof r==='undefined') r=5; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill) ctx.fill(); if(stroke) ctx.stroke(); }
    }

    // Toast helper
    function showToast(message, type='info', timeout=3500){
      const container = document.getElementById('toastContainer');
      if(!container) return console.log(message);
      const el = document.createElement('div');
      el.className = 'toast';
      el.style.cssText = 'background:#111827;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 8px 20px rgba(2,6,23,0.2);min-width:180px;transition:opacity .3s,transform .3s';
      if(type==='success') el.style.background = '#065f46';
      if(type==='error') el.style.background = '#7f1d1d';
      el.textContent = message;
      container.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; setTimeout(()=>el.remove(),400); }, timeout);
    }

    // Student selector modal: opens a searchable list and calls onSelect(student) when chosen
    function openStudentSelector(onSelect){
      const modal = document.getElementById('studentSelectorModal');
      const list = document.getElementById('studentSelectorList');
      const search = document.getElementById('studentSelectorSearch');
      const instr = document.getElementById('studentSelectorInstructions');
      function renderList(filter=''){
        const users = getUsersFromLocal().filter(u=> (u.userType||'').toLowerCase() === 'student');
        const q = (filter||'').toLowerCase();
        list.innerHTML = '';
        const filtered = users.filter(u=> (u.fullName||u.email||'').toLowerCase().includes(q));
        if(filtered.length===0){ list.innerHTML = '<p style="color:#666;padding:8px">No students found.</p>'; return; }
        filtered.forEach(u=>{
          const row = document.createElement('div');
          row.style.cssText = 'padding:10px;cursor:pointer;border-bottom:1px solid #f3f4f6';
          row.tabIndex = 0;
          row.innerHTML = `<strong style="display:block">${u.fullName||u.email}</strong><span style="font-size:12px;color:#6b7280">${u.email||''} ‚Ä¢ ${u.schoolId||''}</span>`;
          row.addEventListener('click', ()=>{ modal.style.display='none'; if(onSelect) onSelect({ email: u.email, name: u.fullName||u.email, grades: u.grades||{}, interviewReport: u.interviewReport||'' }); });
          list.appendChild(row);
        });
      }
      search.value=''; renderList('');
      // show/hide instructions when the search box is empty
      function refreshInstructions(){ if(!instr) return; if((search.value||'').trim()===''){ instr.style.display='block'; } else { instr.style.display='none'; } }
      refreshInstructions();
      search.oninput = (ev)=>{ renderList(ev.target.value); refreshInstructions(); };
      // If user presses Enter with an empty field, show a short instructions page in analytics modal
      search.onkeydown = (ev)=>{ if(ev.key=== 'Enter'){ ev.preventDefault(); if((search.value||'').trim()===''){ modal.style.display='none'; if(onSelect) onSelect(null); // caller will handle null -> show instructions
            // show quick instructions
            document.getElementById('analyticsModalTitle').textContent = 'How to use Interview Reports';
            document.getElementById('analyticsChartSubtitle').textContent = '';
            document.getElementById('analyticsReportText').innerHTML = '<h3>Instructions</h3><ul><li>To view an interview report: type the student\'s name above and select the student from the list.</li><li>If the student has grades, the report will show core subject performance and a recommendation.</li><li>Use the Edit button on a student card to add grades or a custom interview note.</li></ul>';
            document.getElementById('analyticsModal').style.display='flex';
          } } };
      document.getElementById('studentSelectorClose').onclick = ()=>{ modal.style.display='none'; if(onSelect) onSelect(null); };
      modal.style.display = 'flex';
    }

    // Close buttons and modal helpers
    document.getElementById('edit-close-btn').addEventListener('click', ()=> document.getElementById('editModal').style.display='none');
    document.getElementById('add-close-btn').addEventListener('click', ()=> document.getElementById('addStudentModal').style.display='none');
    document.getElementById('analytics-close-btn').addEventListener('click', ()=> document.getElementById('analyticsModal').style.display='none');

    // Init on DOM ready
    document.addEventListener('DOMContentLoaded', ()=>{
      // Role-based UI: hide add controls for non-teachers/admins ‚Äî but always show on teacher dashboard page
      const userEmail = localStorage.getItem('userEmail') || '';
      const currentUser = getUsersFromLocal().find(u => (u.email||'').toLowerCase() === (userEmail||'').toLowerCase());
      const role = (currentUser && currentUser.userType) ? (currentUser.userType||'').toLowerCase() : '';
      const isTeacherPage = (window.location.pathname || '').toLowerCase().includes('teacher_dashboard.html') || (window.location.href || '').toLowerCase().includes('teacher_dashboard.html');
      if(!(role === 'teacher' || role === 'admin') && !isTeacherPage){
        const addBtn = document.getElementById('addStudentBtn'); if(addBtn) addBtn.style.display = 'none';
        const sideAdd = document.getElementById('sidebarAddStudent'); if(sideAdd) sideAdd.style.display = 'none';
      }
      // No header quick-add button ‚Äî page has its own add controls

      loadDashboardData();
      document.getElementById('generateReportBtn').addEventListener('click', ()=>{
        let reportHtml=''; let high=0,med=0,low=0; let anyGrades=false;
        students.forEach(s=>{ const r = getInterviewRecommendation(s); if(r.status==='high') high++; if(r.status==='medium') med++; if(r.status==='low') low++; if(s.grades && Object.keys(s.grades).length>0) anyGrades=true; reportHtml += `<div style="margin-bottom:10px;padding-bottom:6px;border-bottom:1px dashed #eee"><h4 style=\"margin:0 0 6px 0\">${s.name} (${s.id})</h4><p style=\"margin:0 0 6px 0;color:#444\">${r.text}</p><p style=\"margin:0;color:#666;font-size:13px\">${s.interviewReport||''}</p></div>`; });

        // Title and subtitle
        document.getElementById('analyticsModalTitle').textContent = 'Report';
        document.getElementById('analyticsChartSubtitle').textContent = anyGrades ? 'Overview of student averages' : 'No grade data yet ‚Äî add grades to populate charts';

        // Left panel: show chart if we have any grade data, otherwise show a friendly placeholder card
        const canvas = document.getElementById('analyticsChart');
        const placeholder = document.getElementById('chartPlaceholder');
        if(anyGrades){
          // attempt to draw a small aggregated chart
          placeholder.style.display = 'none';
          canvas.style.display = 'block';
          generateAnalyticsChart();
        } else {
          canvas.style.display = 'none';
          placeholder.style.display = 'flex';
          // inject a clearer empty-state into the placeholder
          placeholder.innerHTML = `
            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
              <div style=\"width:88%;height:86%;border-radius:10px;background:linear-gradient(180deg,#fbfdff,#f7fbfb);box-shadow:0 8px 26px rgba(2,6,23,0.06);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;\">
                <div style=\"font-size:36px;margin-bottom:8px;opacity:0.85\">üìä</div>
                <div style=\"font-weight:700;margin-bottom:6px\">No chart data</div>
                <div style=\"color:#6b7280;font-size:13px;text-align:center\">Add grades to students or open an individual student report to see analytics here.</div>
              </div>
            </div>`;
        }

        // Right panel: report summary and per-student blocks
        document.getElementById('analyticsReportText').innerHTML = `<h3 style="margin-top:0">Summary</h3><p style=\"margin:6px 0 12px 0;color:#444\">High: <strong>${high}</strong> &nbsp; Medium: <strong>${med}</strong> &nbsp; Low: <strong>${low}</strong></p><div style=\"max-height:280px;overflow:auto;padding-right:6px\">${reportHtml}</div>`;

        document.getElementById('analyticsModal').style.display='flex';
      });
      // render analytics controls upfront so they're ready when modal opens
      try{ renderAnalyticsControls(); } catch(e){}
    });
  </script>
</body>
</html>